{"version":3,"sources":["../src/captcha-clientside-workflow.js"],"names":["window","displayHtml","settings","bdcElements","document","getElementsByClassName","length","bdcElement","captchaStyleName","getAttribute","captchaHtmlUrl","commonFunctions","buildUrl","captchaEndpoint","get","c","helpers","ajax","response","status","Error","captchaHtml","responseText","baseUrl","getBaseUrl","callback","innerHTML","replace","addInitScriptToBody","addScriptToBody","bodyElement","body","getElementsByTagName","defaultSettings","String","prototype","trim","this","extend","configuredSettings","key","settingValue","xhr","x","XMLHttpRequest","e","ActiveXObject","url","readyState","onreadystatechange","open","send","parseJson","jsonString","resultObj","JSON","parse","eval","matched","match","params","p","push","test","join","scriptInclude","className","onLoadedCallback","script","createElement","src","onload","appendChild","initScriptIncluded","parentNode","removeChild","captchaId","getElementById","initScriptIncludeUrl","t","value","cs","Captcha","config","init","validate","isCorrectCaptcha","captcha","getInstance","captchaCode","userInput","validationUrl","reloadImage","savedCaptchaStyleName","BotDetect","getInstanceByStyleName"],"mappings":"CAAC,SAASA,QACR,YAkKA,SAASC,aAAYC,GAEnB,GAAIC,GAAcC,SAASC,uBAAuB,oBAElD,IAA2B,IAAvBF,EAAYG,OAAhB,CAKA,GAAIC,GAAaJ,EAAY,GAGzBK,EAAmBD,EAAWE,aAAa,iBAE1CD,KACHA,EAAmB,kBAIrBR,OAAkC,0BAAIQ,CAGtC,IAAIE,GAAiBC,gBAAgBC,SAASV,EAASW,iBACrDC,IAAK,OACLC,EAAGP,GAGLQ,SAAQC,KAAKH,IAAIJ,EAAgB,SAASQ,GACxC,GAAwB,MAApBA,EAASC,OAaX,KAAM,IAAIC,OAAM,uDAZhB,IAAIC,GAAcH,EAASI,aACvBC,EAAUP,QAAQQ,WAAWH,GAE7BI,EAAW,WACblB,EAAWmB,UAAYL,EAAYM,QAAQ,uBAAwB,IAEnEhB,gBAAgBiB,oBAAoBpB,EAAkBN,EAASW,gBAAiBU,GAIlFZ,iBAAgBkB,gBAAgB3B,EAASW,gBAAiBU,EAASE,MAvMzE,GAAIrB,UAAWJ,OAAOI,SAClB0B,YAAc1B,SAAS2B,MAAQ3B,SAAS4B,qBAAqB,QAAQ,GAErEC,iBACFpB,gBAAiB,GAIdqB,QAAOC,UAAUC,OACpBF,OAAOC,UAAUC,KAAO,WACtB,MAAOC,MAAKV,QAAQ,qCAAsC,KAK9D,IAAIX,UACFsB,OAAQ,SAASC,EAAoBN,GACnC,GAAI/B,KACJ,KAAK,GAAIsC,KAAOP,GAAiB,CAC/B,GAAIQ,GAAeF,EAAmBC,EACtCtC,GAASsC,OAAgC,KAAjBC,EAAgCR,EAAgBO,GAAOC,EAEjF,MAAOvC,IAITe,MACEyB,IAAK,WACH,GAAIC,GAAI,IACR,KAAgC,MAA1BA,GAAI,GAAIC,gBAA8B,MAAOC,IACnD,IAAmD,MAA7CF,GAAI,GAAIG,eAAc,sBAAmC,MAAOD,IACtE,IAAmD,MAA7CF,GAAI,GAAIG,eAAc,sBAAmC,MAAOD,IACtE,IAAmD,MAA7CF,GAAI,GAAIG,eAAc,sBAAmC,MAAOD,IACtE,IAA+C,MAAzCF,GAAI,GAAIG,eAAc,kBAA+B,MAAOD,IAClE,IAAkD,MAA5CF,GAAI,GAAIG,eAAc,qBAAkC,MAAOD,IACrE,MAAOF,IAGT7B,IAAK,SAASiC,EAAKtB,GACjB,GAAIiB,GAAML,KAAKK,KACXA,IAA0B,IAAnBA,EAAIM,aACbN,EAAIO,mBAAqB,WACA,IAAnBP,EAAIM,YACNvB,EAASiB,IAGbA,EAAIQ,KAAK,MAAOH,GAAK,GACrBL,EAAIS,UAKVC,UAAW,SAASC,YAClB,GAAIC,WAAY,IAOhB,OANqB,mBAAX,OAAiD,kBAAhBC,MAAU,QACnDD,UAAYC,KAAKC,MAAMH,aAEpBC,YACHA,UAAYG,KAAK,IAAMJ,WAAa,MAE/BC,WAIT9B,WAAY,SAASH,GACnB,GAAIE,GAAU,GACVmC,EAAUrC,EAAYsC,MAAM,6CAIhC,OAHID,KACFnC,EAAUmC,EAAQ,IAEbnC,IAMPZ,iBAEFC,SAAU,SAASmC,EAAKa,GACtB,GAAIC,KAEJ,KAAK,GAAIrB,KAAOoB,GACK,gBAARpB,IACTqB,EAAEC,KAAKtB,EAAM,IAAMoB,EAAOpB,GAK9B,OADuB,OACCuB,KAAKhB,GAAQA,EAAM,IAAMc,EAAEG,KAAK,KAASjB,EAAM,IAAMc,EAAEG,KAAK,MAItFC,cAAe,SAASlB,EAAKmB,EAAWC,GACtC,GAAIC,GAAShE,SAASiE,cAAc,SAqBpC,OApBID,GAAOE,IAAMvB,EACbqB,EAAOF,UAAYA,EAEnBE,EAAOpB,WACToB,EAAOnB,mBAAqB,WACC,WAAtBmB,EAAOpB,YACoB,aAAtBoB,EAAOpB,YACiB,kBAArBmB,IACTA,KAKNC,EAAOG,OAAS,WACkB,kBAArBJ,IACPA,KAKDC,GAITvC,gBAAiB,SAAShB,EAAiBU,EAASE,GAClD,GAAoE,IAAhErB,SAASC,uBAAuB,qBAAqBC,OAAzD,CAMA,GAAIyC,GAAMV,KAAKzB,SAASW,EAAUV,GAChCC,IAAK,kBAGPgB,aAAY0C,YAAYnC,KAAK4B,cAAclB,EAAK,oBAAqBtB,MAIvEG,oBAAqB,SAASpB,EAAkBK,EAAiBU,EAASE,GAExE,GAAIgD,GAAqBrE,SAASC,uBAAuB,wBACvB,KAA9BoE,EAAmBnE,QACrBmE,EAAmB,GAAGC,WAAWC,YAAYF,EAAmB,GAGlE,IAAIG,GAAYxE,SAASyE,eAAe,YAAcrE,EAEtD,IAAKoE,EAAL,CAKA,GAAIE,GAAuBzC,KAAKzB,SAASW,EAAUV,GACjDC,IAAK,sBACLC,EAAGP,EACHuE,EAAGH,EAAUI,MACbC,GAAI,KAGNnD,aAAY0C,YAAYnC,KAAK4B,cAAca,EAAsB,wBAAyBrD,OAqD1FyD,QAAUA,WAEdA,SAAQC,OAAS,SAAS5C,GACxB,GAAIrC,GAAWc,QAAQsB,OAAOC,MAA0BN,gBAGxD/B,GAASW,gBAAkBX,EAASW,gBAAgBc,QAAQ,QAAS,IAGrEuD,QAAQE,KAAKlF,IAGfgF,QAAQE,KAAO,SAASlF,GACtBgF,QAAQjF,YAAYC,IAGtBgF,QAAQjF,YAAc,SAASC,GAED,aAAxBE,SAAS4C,WACX/C,YAAYC,GAEZE,SAAS6C,mBAAqB,WACA,aAAxB7C,SAAS4C,YACX/C,YAAYC,KAQpBgF,QAAQG,SAAW,SAAS5D,GAC1B,GAAI6D,IAAmB,EAEnBC,EAAUL,QAAQM,aAEtB,KAAKD,EACH,KAAM,IAAInE,OAAM,yDAGlB,IAAIqE,GAAcF,EAAQG,UAAUV,MAAM5C,MAE1C,MAAIqD,EAAYnF,OAAS,GAAzB,CAIA,GAAIqF,GAAgBJ,EAAQI,cAAgB,MAAQF,CAEpDzE,SAAQC,KAAKH,IAAI6E,EAAe,SAASzE,GACvC,GAAwB,MAApBA,EAASC,OAYX,KAAM,IAAIC,OAAM,8CAXhBkE,GAAmBtE,QAAQoC,UAAUlC,EAASI,cAI9CG,EAAS6D,GAGJA,GACHC,EAAQK,kBAQhBV,QAAQM,YAAc,WACpB,GAAIK,GAAwB7F,OAAkC,yBAE9D,OAAK6F,GAIEC,UAAUC,uBAAuBF,GAH/B,MAMX7F,OAAOkF,QAAUA,SACjBlF","file":"captcha-clientside-workflow.min.js","sourcesContent":["(function(window) {\r\n  'use strict';\r\n  \r\n  var document = window.document,\r\n      bodyElement = document.body || document.getElementsByTagName('body')[0];\r\n  \r\n  var defaultSettings = {\r\n    captchaEndpoint: '' // e.g. '/user-app/botdetectcaptcha' or '/user-app/simplebotdetect.php' or '/user-app/BotDetectCaptcha.ashx'\r\n  };\r\n  \r\n  // Polyfill for trim() method\r\n  if (!String.prototype.trim) {\r\n    String.prototype.trim = function () {\r\n      return this.replace(/^[\\s\\uFEFF\\xA0]+|[\\s\\uFEFF\\xA0]+$/g, '');\r\n    };\r\n  }\r\n  \r\n  // Helper functions\r\n  var helpers = {\r\n    extend: function(configuredSettings, defaultSettings) {\r\n      var settings = {};\r\n      for (var key in defaultSettings) {\r\n        var settingValue = configuredSettings[key];\r\n        settings[key] = (typeof settingValue === 'undefined') ? defaultSettings[key] : settingValue;\r\n      }\r\n      return settings;\r\n    },\r\n    \r\n    // ajax helper\r\n    ajax: {\r\n      xhr: function() {\r\n        var x = null;\r\n        try { x = new XMLHttpRequest(); return x; } catch (e) {}\r\n        try { x = new ActiveXObject('MSXML2.XMLHTTP.5.0'); return x; } catch (e) {}\r\n        try { x = new ActiveXObject('MSXML2.XMLHTTP.4.0'); return x; } catch (e) {}\r\n        try { x = new ActiveXObject('MSXML2.XMLHTTP.3.0'); return x; } catch (e) {}\r\n        try { x = new ActiveXObject('MSXML2.XMLHTTP'); return x; } catch (e) {}\r\n        try { x = new ActiveXObject('Microsoft.XMLHTTP'); return x; } catch (e) {}\r\n        return x;\r\n      },\r\n\r\n      get: function(url, callback) {\r\n        var xhr = this.xhr();\r\n        if (xhr && xhr.readyState === 0) {\r\n          xhr.onreadystatechange = function() {\r\n            if (xhr.readyState === 4) {\r\n              callback(xhr);\r\n            }\r\n          };\r\n          xhr.open('GET', url, true);\r\n          xhr.send();\r\n        }\r\n      }\r\n    },\r\n    \r\n    parseJson: function(jsonString) {\r\n      var resultObj = null;\r\n      if (typeof(JSON) !== 'undefined' && typeof(JSON.parse) === 'function') {\r\n        resultObj = JSON.parse(jsonString);\r\n      }\r\n      if (!resultObj) {\r\n        resultObj = eval('(' + jsonString + ')');\r\n      }\r\n      return resultObj;\r\n    },\r\n    \r\n    // get configured base url thougth captcha html\r\n    getBaseUrl: function(captchaHtml) {\r\n      var baseUrl = '';\r\n      var matched = captchaHtml.match(/id=['\"]BDC_BaseUrl['\"].*value=['\"]([^'\"]+)/);\r\n      if (matched) {\r\n        baseUrl = matched[1];\r\n      }\r\n      return baseUrl;\r\n    }\r\n    \r\n  };\r\n\r\n  // The common functions that will be shared to other javascript frameworks.\r\n  var commonFunctions = {\r\n    // build url with parameters\r\n    buildUrl: function(url, params) {\r\n      var p = [];\r\n\r\n      for (var key in params) {\r\n        if (typeof key === 'string') {\r\n          p.push(key + '=' + params[key]);\r\n        }\r\n      }\r\n\r\n      var hasParamsPattern = /\\?+/g;\r\n      return hasParamsPattern.test(url) ? (url + '&' + p.join('&')) : (url + '?' + p.join('&')); \r\n    },\r\n\r\n    // create script include element\r\n    scriptInclude: function(url, className, onLoadedCallback) {\r\n      var script = document.createElement('script');\r\n          script.src = url;\r\n          script.className = className;\r\n      \r\n      if (script.readyState) { // for IE\r\n        script.onreadystatechange = function() {\r\n          if ((script.readyState === 'loaded') \r\n                || (script.readyState === 'complete')) {\r\n            if (typeof onLoadedCallback === 'function') {\r\n              onLoadedCallback();\r\n            }\r\n          }\r\n        };\r\n      } else {\r\n        script.onload = function() {\r\n          if (typeof onLoadedCallback === 'function') {\r\n              onLoadedCallback();\r\n            }\r\n        };\r\n      }\r\n      \r\n      return script;\r\n    },\r\n\r\n    // Add BotDetect client-side script include to body element.\r\n    addScriptToBody: function(captchaEndpoint, baseUrl, callback) {\r\n      if (document.getElementsByClassName('BDC_ScriptInclude').length !== 0) {\r\n        // BotDetect client-side script is already added\r\n        return;\r\n      }\r\n\r\n      // build BotDetect client-side script include url\r\n      var url = this.buildUrl(baseUrl + captchaEndpoint, {\r\n        get: 'script-include'\r\n      });\r\n      \r\n      bodyElement.appendChild(this.scriptInclude(url, 'BDC_ScriptInclude', callback));\r\n    },\r\n\r\n    // Add BotDetect init script include to body element.\r\n    addInitScriptToBody: function(captchaStyleName, captchaEndpoint, baseUrl, callback) {\r\n      // remove included BotDetect init script if it exists\r\n      var initScriptIncluded = document.getElementsByClassName('BDC_InitScriptInclude');\r\n      if (initScriptIncluded.length !== 0) {\r\n        initScriptIncluded[0].parentNode.removeChild(initScriptIncluded[0]);\r\n      }\r\n\r\n      var captchaId = document.getElementById('BDC_VCID_' + captchaStyleName);\r\n\r\n      if (!captchaId) {\r\n        return;\r\n      }\r\n\r\n      // build BotDetect init script include url.\r\n      var initScriptIncludeUrl = this.buildUrl(baseUrl + captchaEndpoint, {\r\n        get: 'init-script-include',\r\n        c: captchaStyleName,\r\n        t: captchaId.value,\r\n        cs: '2'\r\n      });\r\n\r\n      bodyElement.appendChild(this.scriptInclude(initScriptIncludeUrl, 'BDC_InitScriptInclude', callback));\r\n    }\r\n\r\n  };\r\n\r\n  // Display captcha html markup in view.\r\n  function displayHtml(settings) {\r\n    // get botdetect-captcha element for showing captcha html\r\n    var bdcElements = document.getElementsByClassName('botdetect-captcha');\r\n\r\n    if (bdcElements.length === 0) {\r\n      return;\r\n    }\r\n\r\n    // we currently support only one captcha on a page\r\n    var bdcElement = bdcElements[0];\r\n\r\n    // captcha style name\r\n    var captchaStyleName = bdcElement.getAttribute('data-stylename');\r\n\r\n    if (!captchaStyleName) {\r\n      captchaStyleName = 'defaultCaptcha';\r\n    }\r\n\r\n    // save captchaStyleName in window object, that will be used in Captcha.getInstance() for getting BotDetect instance\r\n    window['bdc_clientside_style_name'] = captchaStyleName;\r\n\r\n    // build captcha html url\r\n    var captchaHtmlUrl = commonFunctions.buildUrl(settings.captchaEndpoint, {\r\n      get: 'html',\r\n      c: captchaStyleName\r\n    });\r\n\r\n    helpers.ajax.get(captchaHtmlUrl, function(response) {\r\n      if (response.status === 200) {\r\n        var captchaHtml = response.responseText;\r\n        var baseUrl = helpers.getBaseUrl(captchaHtml);\r\n        \r\n        var callback = function() {\r\n          bdcElement.innerHTML = captchaHtml.replace(/<script.*<\\/script>/g, '');\r\n          // add BotDetect Init script to body\r\n          commonFunctions.addInitScriptToBody(captchaStyleName, settings.captchaEndpoint, baseUrl);\r\n        };\r\n        \r\n        // add BotDetect script to body before displaying Captcha html\r\n        commonFunctions.addScriptToBody(settings.captchaEndpoint, baseUrl, callback);\r\n      } else {\r\n        throw new Error('An error occurred while getting Captcha html markup.');\r\n      }\r\n    });\r\n  }\r\n  \r\n  // Captcha client-side object.\r\n  var Captcha = Captcha || {};\r\n  \r\n  Captcha.config = function(configuredSettings) {\r\n    var settings = helpers.extend(configuredSettings || {}, defaultSettings);\r\n\r\n    // remove the '/' last char of url if it exists\r\n    settings.captchaEndpoint = settings.captchaEndpoint.replace(/\\/+$/i, '');\r\n    \r\n    // display captcha html markup on the view\r\n    Captcha.init(settings);\r\n  };\r\n  \r\n  Captcha.init = function(settings) {\r\n    Captcha.displayHtml(settings);\r\n  };\r\n  \r\n  Captcha.displayHtml = function(settings) {\r\n    // display Captcha htmt markup when DOM content is loaded\r\n    if (document.readyState === 'complete') {\r\n      displayHtml(settings);\r\n    } else {\r\n      document.onreadystatechange = function() {\r\n        if (document.readyState === \"complete\") {\r\n          displayHtml(settings);\r\n        }\r\n      };\r\n    }\r\n  };\r\n  \r\n  // Perform UI captcha validation.\r\n  // It will be invoked on blur event by user.\r\n  Captcha.validate = function(callback) {\r\n    var isCorrectCaptcha = false;\r\n    \r\n    var captcha = Captcha.getInstance();\r\n\r\n    if (!captcha) {\r\n      throw new Error('BotDetect Captcha client-side instance does not exist.');\r\n    }\r\n    \r\n    var captchaCode = captcha.userInput.value.trim();\r\n\r\n    if (captchaCode.length < 1) {\r\n      return;\r\n    }\r\n\r\n    var validationUrl = captcha.validationUrl + '&i=' + captchaCode;\r\n\r\n    helpers.ajax.get(validationUrl, function(response) {\r\n      if (response.status === 200) {\r\n        isCorrectCaptcha = helpers.parseJson(response.responseText);\r\n        \r\n        // invoke user callback function and fire the validation result through the parameter.\r\n        // so user can use it for either displaying messages or checking captcha code input field status when form is submitted\r\n        callback(isCorrectCaptcha);\r\n        \r\n        // reload captcha image when validation failed\r\n        if (!isCorrectCaptcha) {\r\n          captcha.reloadImage();\r\n        }\r\n      } else {\r\n        throw new Error('An error occurred while validating Captcha.');\r\n      }\r\n    });\r\n  };\r\n  \r\n  Captcha.getInstance = function() {\r\n    var savedCaptchaStyleName = window['bdc_clientside_style_name'];\r\n    \r\n    if (!savedCaptchaStyleName) {\r\n      return null;\r\n    }\r\n\r\n    return BotDetect.getInstanceByStyleName(savedCaptchaStyleName);\r\n  };\r\n  \r\n  window.Captcha = Captcha;\r\n}(window));\r\n"]}